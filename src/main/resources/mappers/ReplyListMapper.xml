<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.mycompany.myapp.ReplyListMapper">
  	<insert id="insert" parameterType="ReplyList" useGeneratedKeys="true" keyProperty="rnum">
  		insert into ReplyList(memail, pnum, rsubject, rcontent) 
  		values (#{memail}, #{pnum}, #{rsubject}, #{rcontent})
  	</insert>
  	<update id="update">
  		update ReplyList
		set
		rsubject = #{rsubject},
		rcontent = #{rcontent},
		modidate = now()
		where rnum = #{rnum}
  	</update>
  	<delete id="delete">
  		delete from ReplyList
		where rnum = #{rnum}
  	</delete>
  	<!-- 한 게시물의 모든 댓글 삭제 -->
  	<delete id="deleteAll">
  		delete from ReplyList
		where pnum = #{pnum}
  	</delete>
  	<select id="selectOne" resultType="ReplyList">
  		select * from ReplyList
		Where rnum = #{rnum}
  	</select>
  	<select id="selectList" resultType="ReplyList">
  		select * from ReplyList
		where pnum = #{pnum}
		and rremoveyn = 'n'
			<include refid="find"/>
		order by rnum desc
		limit #{startNum} , #{perPage}
  	</select>
  	<!-- 댓글 순서 재수정 -->
  	<update id="updateRestep">
  		update ReplyList
		set
		restep = restep+1
		where pnum = #{pnum}
		and restep >= #{restep}
  	</update>
  	<update id="updateHelp">
  		UPDATE ReplyList
		SET help = help +1
		WHERE rnum = #{rnum}
  	</update>
  	<update id="updateUseless">
  		UPDATE ReplyList
		SET useless = useless +1
		WHERE rnum = #{rnum}
  	</update>
  	<!-- 삭제시 삭제 여부를 y로 변경 -->
  	<update id="updateRremoveyn">
  		UPDATE ReplyList
		SET rremoveyn = 'y'
		WHERE rnum = #{rnum}
  	</update>
  	<!-- 전체댓글수 구하기 -->
  	<select id="selectTotalCnt" resultType="int">
  		SELECT COUNT(*) totalCnt FROM ReplyList
		WHERE pnum = #{pnum}
		<include refid="find"/>
  	</select>
  	<sql id="find">
  		<if test="findkey =='pnum'">
			AND pnum LIKE  concat('%' , #{findvalue} , '%')
		</if>
		<if test="findkey =='rsubject'">
			AND rsubject LIKE rsubject('%' , #{findvalue} , '%')
		</if>
		<if test="findkey =='rcontent'">
			AND rcontent LIKE concat('%' , #{findvalue} , '%')
		</if>	
  		<if test="findkey=='rsubcon'">
			AND (rsubject LIKE concat('%' , #{findvalue} , '%')
		   		OR rcontent LIKE concat('%' , #{findvalue} , '%'))
  		</if>
  		<if test="findkey =='remail'">
			AND remail LIKE  concat('%' , #{findvalue} , '%')
		</if>
   	</sql>
  </mapper>